<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIREN - Immersive 3D Experience</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Outfit', sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        /* Loading Screen */
        .splat-loader {
            position: fixed;
            inset: 0;
            background: #0a0a0c;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.8s ease, visibility 0.8s ease;
        }

        .splat-loader.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .loader-logo {
            font-size: 2rem;
            font-weight: 800;
            letter-spacing: 0.25em;
            text-transform: uppercase;
            margin-bottom: 2rem;
            background: linear-gradient(180deg, #fcd7a0 0%, #f97316 25%, #ef4444 50%, #dc2626 75%, #991b1b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
        }

        .loader-logo::before {
            content: 'SIREN';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, #ef4444, #f97316);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: blur(15px);
            opacity: 0.5;
            z-index: -1;
        }

        .loader-progress {
            width: 200px;
            height: 3px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .loader-progress-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #f97316, #ef4444);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .loader-status {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.5);
        }

        /* Splat Canvas Container */
        .splat-container {
            position: fixed;
            inset: 0;
            background: #000;
        }

        #splat-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* Controls Overlay */
        .viewer-controls {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 0.5rem;
            padding: 0.75rem;
            background: rgba(15, 15, 20, 0.6);
            backdrop-filter: blur(50px) saturate(200%);
            -webkit-backdrop-filter: blur(50px) saturate(200%);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            z-index: 100;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .viewer-controls.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .control-btn {
            width: 48px;
            height: 48px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            color: rgba(255, 255, 255, 0.7);
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .control-btn.active {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.4);
            color: #ef4444;
        }

        .control-btn svg {
            width: 22px;
            height: 22px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
        }

        .control-divider {
            width: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 0.5rem 0.25rem;
        }

        /* Top Bar */
        .viewer-topbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to bottom, rgba(0,0,0,0.7) 0%, transparent 100%);
            z-index: 100;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .viewer-topbar.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .back-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #fff;
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .back-btn svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
        }

        .content-title {
            text-align: center;
        }

        .content-title h1 {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .content-title span {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .immersive-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(168, 85, 247, 0.15));
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 20px;
            font-size: 0.8rem;
            color: #a78bfa;
        }

        .immersive-badge svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            fill: none;
        }

        /* Info Panel */
        .info-panel {
            position: fixed;
            right: 2rem;
            top: 50%;
            transform: translateY(-50%);
            width: 280px;
            padding: 1.5rem;
            background: rgba(15, 15, 20, 0.6);
            backdrop-filter: blur(50px) saturate(200%);
            -webkit-backdrop-filter: blur(50px) saturate(200%);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 16px;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .info-panel.visible {
            opacity: 1;
            visibility: visible;
        }

        .info-panel h3 {
            font-size: 1rem;
            margin-bottom: 1rem;
            color: #fff;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            font-size: 0.85rem;
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            color: rgba(255, 255, 255, 0.5);
        }

        .info-value {
            color: #fff;
        }

        /* Instructions Overlay */
        .instructions {
            position: fixed;
            bottom: 7rem;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 1.5rem;
            background: rgba(15, 15, 20, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
            z-index: 100;
            transition: opacity 0.5s ease;
        }

        .instructions.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .instructions strong {
            color: #fff;
        }

        /* VR Mode Styles */
        .vr-prompt {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .vr-prompt.visible {
            opacity: 1;
            visibility: visible;
        }

        .vr-prompt h2 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .vr-prompt p {
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 2rem;
        }

        .vr-btn {
            padding: 1rem 2rem;
            background: linear-gradient(135deg, #8b5cf6, #a855f7);
            border: none;
            border-radius: 12px;
            color: #fff;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .vr-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(139, 92, 246, 0.4);
        }

        /* Hotspots */
        .hotspot {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(239, 68, 68, 0.3);
            border: 2px solid rgba(239, 68, 68, 0.8);
            cursor: pointer;
            animation: hotspotPulse 2s infinite;
            z-index: 50;
            display: none;
        }

        @keyframes hotspotPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { transform: scale(1.1); box-shadow: 0 0 20px 5px rgba(239, 68, 68, 0.2); }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="splat-loader" id="splatLoader">
        <div class="loader-logo">SIREN</div>
        <div class="loader-progress">
            <div class="loader-progress-fill" id="loaderFill"></div>
        </div>
        <div class="loader-status" id="loaderStatus">Initializing immersive experience...</div>
    </div>

    <!-- Splat Viewer Container -->
    <div class="splat-container">
        <canvas id="splat-canvas"></canvas>
    </div>

    <!-- Top Bar -->
    <div class="viewer-topbar" id="viewerTopbar">
        <a href="../browse/" class="back-btn">
            <svg viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
            Back
        </a>
        <div class="content-title">
            <h1>Velvet Dreams</h1>
            <span>Featuring Aria Rose</span>
        </div>
        <div class="immersive-badge">
            <svg viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
            3D Immersive
        </div>
    </div>

    <!-- Controls -->
    <div class="viewer-controls" id="viewerControls">
        <button class="control-btn" id="resetBtn" title="Reset View">
            <svg viewBox="0 0 24 24"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
        </button>
        <button class="control-btn" id="autoRotateBtn" title="Auto Rotate">
            <svg viewBox="0 0 24 24"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 3"/><path d="M21 3v5h-5"/></svg>
        </button>
        <div class="control-divider"></div>
        <button class="control-btn" id="zoomInBtn" title="Zoom In">
            <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></svg>
        </button>
        <button class="control-btn" id="zoomOutBtn" title="Zoom Out">
            <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="8" y1="11" x2="14" y2="11"/></svg>
        </button>
        <div class="control-divider"></div>
        <button class="control-btn" id="infoBtn" title="Info">
            <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
        </button>
        <button class="control-btn" id="fullscreenBtn" title="Fullscreen">
            <svg viewBox="0 0 24 24" class="expand-icon"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg>
            <svg viewBox="0 0 24 24" class="compress-icon" style="display:none"><polyline points="4 14 10 14 10 20"/><polyline points="20 10 14 10 14 4"/><line x1="14" y1="10" x2="21" y2="3"/><line x1="3" y1="21" x2="10" y2="14"/></svg>
        </button>
        <button class="control-btn" id="vrBtn" title="VR Mode">
            <svg viewBox="0 0 24 24"><path d="M3 8a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-3l-2 2-2-2H5a2 2 0 0 1-2-2V8z"/><circle cx="8" cy="12" r="2"/><circle cx="16" cy="12" r="2"/></svg>
        </button>
    </div>

    <!-- Instructions -->
    <div class="instructions" id="instructions">
        <strong>Click & drag</strong> to orbit • <strong>Scroll</strong> to zoom • <strong>Right-click & drag</strong> to pan
    </div>

    <!-- Info Panel -->
    <div class="info-panel" id="infoPanel">
        <h3>Scene Information</h3>
        <div class="info-item">
            <span class="info-label">Format</span>
            <span class="info-value">3D Gaussian Splat</span>
        </div>
        <div class="info-item">
            <span class="info-label">Resolution</span>
            <span class="info-value">4K Ultra HD</span>
        </div>
        <div class="info-item">
            <span class="info-label">Splat Count</span>
            <span class="info-value" id="splatCount">Loading...</span>
        </div>
        <div class="info-item">
            <span class="info-label">Camera</span>
            <span class="info-value">Free Orbit</span>
        </div>
        <div class="info-item">
            <span class="info-label">VR Ready</span>
            <span class="info-value">Yes</span>
        </div>
    </div>

    <!-- VR Prompt -->
    <div class="vr-prompt" id="vrPrompt">
        <h2>Enter VR Mode</h2>
        <p>Put on your headset and click to enter immersive mode</p>
        <button class="vr-btn" id="enterVrBtn">Enter VR</button>
    </div>

    <!-- Gaussian Splatting Library -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.157.0/examples/jsm/"
        }
    }
    </script>
    <script type="module">
        // Gaussian Splatting Viewer using Three.js
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // Elements
        const canvas = document.getElementById('splat-canvas');
        const loader = document.getElementById('splatLoader');
        const loaderFill = document.getElementById('loaderFill');
        const loaderStatus = document.getElementById('loaderStatus');
        const instructions = document.getElementById('instructions');
        const viewerControls = document.getElementById('viewerControls');
        const viewerTopbar = document.getElementById('viewerTopbar');
        const infoPanel = document.getElementById('infoPanel');

        // Three.js setup
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0a0a0c);
        
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 1.2, 2.5);

        const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

        // Controls
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.minDistance = 0.5;
        controls.maxDistance = 8;
        controls.target.set(0, 0.9, 0);
        controls.autoRotate = false;
        controls.autoRotateSpeed = 0.8;

        // Subtle environment
        const ambientLight = new THREE.AmbientLight(0xffeedd, 0.3);
        scene.add(ambientLight);

        // Warm key light
        const keyLight = new THREE.DirectionalLight(0xffaa77, 0.8);
        keyLight.position.set(3, 4, 2);
        scene.add(keyLight);

        // Cool fill light
        const fillLight = new THREE.DirectionalLight(0x7799ff, 0.3);
        fillLight.position.set(-3, 2, -2);
        scene.add(fillLight);

        // Rim light
        const rimLight = new THREE.DirectionalLight(0xff6644, 0.4);
        rimLight.position.set(0, 2, -3);
        scene.add(rimLight);

        // Custom shader for gaussian-like splats
        const splatVertexShader = `
            attribute float size;
            attribute vec3 customColor;
            attribute float opacity;
            varying vec3 vColor;
            varying float vOpacity;
            void main() {
                vColor = customColor;
                vOpacity = opacity;
                vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
                gl_PointSize = size * (300.0 / -mvPosition.z);
                gl_Position = projectionMatrix * mvPosition;
            }
        `;

        const splatFragmentShader = `
            varying vec3 vColor;
            varying float vOpacity;
            void main() {
                vec2 center = gl_PointCoord - vec2(0.5);
                float dist = length(center);
                float alpha = exp(-dist * dist * 8.0) * vOpacity;
                if (alpha < 0.01) discard;
                gl_FragColor = vec4(vColor, alpha);
            }
        `;

        // Create realistic figure with gaussian splats
        function createGaussianFigure() {
            const particleCount = 150000;
            const positions = new Float32Array(particleCount * 3);
            const colors = new Float32Array(particleCount * 3);
            const sizes = new Float32Array(particleCount);
            const opacities = new Float32Array(particleCount);

            // Skin tones
            const skinBase = new THREE.Color(0.94, 0.78, 0.68);
            const skinWarm = new THREE.Color(0.96, 0.72, 0.62);
            const skinCool = new THREE.Color(0.90, 0.76, 0.72);
            const hairColor = new THREE.Color(0.15, 0.10, 0.08);
            const lipColor = new THREE.Color(0.85, 0.45, 0.48);

            for (let i = 0; i < particleCount; i++) {
                const i3 = i * 3;
                let x, y, z;
                let color = skinBase.clone();
                let size = 0.015;
                let opacity = 0.85;

                const section = Math.random();

                if (section < 0.12) {
                    // Head - sphere
                    const theta = Math.random() * Math.PI * 2;
                    const phi = Math.acos(2 * Math.random() - 1);
                    const r = 0.12 + Math.random() * 0.02;
                    x = r * Math.sin(phi) * Math.cos(theta) * 0.9;
                    y = 1.55 + r * Math.cos(phi);
                    z = r * Math.sin(phi) * Math.sin(theta);
                    
                    // Face features
                    if (z > 0.05 && y > 1.45 && y < 1.6) {
                        color = skinWarm.clone();
                    }
                    size = 0.012 + Math.random() * 0.008;
                    opacity = 0.9;
                } else if (section < 0.18) {
                    // Hair
                    const theta = Math.random() * Math.PI * 2;
                    const phi = Math.acos(2 * Math.random() - 1);
                    const r = 0.14 + Math.random() * 0.06;
                    x = r * Math.sin(phi) * Math.cos(theta);
                    y = 1.6 + r * Math.cos(phi) * 0.7;
                    z = r * Math.sin(phi) * Math.sin(theta) - 0.02;
                    
                    if (y > 1.55) {
                        color = hairColor.clone();
                        color.r += Math.random() * 0.1;
                        color.g += Math.random() * 0.05;
                        size = 0.02 + Math.random() * 0.015;
                        opacity = 0.95;
                    }
                } else if (section < 0.22) {
                    // Neck
                    const angle = Math.random() * Math.PI * 2;
                    const r = 0.05 + Math.random() * 0.02;
                    x = Math.cos(angle) * r;
                    y = 1.35 + Math.random() * 0.1;
                    z = Math.sin(angle) * r;
                    color = skinCool.clone();
                    size = 0.014;
                } else if (section < 0.45) {
                    // Torso - curved form
                    const t = Math.random();
                    const angle = Math.random() * Math.PI * 2;
                    
                    // Vary width along torso
                    const waistY = 0.95;
                    const chestY = 1.25;
                    const hipY = 0.75;
                    
                    y = 0.7 + t * 0.6;
                    
                    let radius;
                    if (y > 1.1) {
                        // Chest area
                        radius = 0.18 + Math.sin((y - 1.1) * 8) * 0.04;
                    } else if (y > 0.85) {
                        // Waist
                        radius = 0.13 + (1.1 - y) * 0.15;
                    } else {
                        // Hips
                        radius = 0.16 + (0.85 - y) * 0.1;
                    }
                    
                    radius += Math.random() * 0.03;
                    x = Math.cos(angle) * radius * (0.85 + Math.random() * 0.3);
                    z = Math.sin(angle) * radius * 0.6;
                    
                    // Color variation
                    const blend = Math.random();
                    color = skinBase.clone().lerp(skinWarm, blend * 0.3);
                    size = 0.014 + Math.random() * 0.008;
                    opacity = 0.88;
                } else if (section < 0.60) {
                    // Arms
                    const side = Math.random() > 0.5 ? 1 : -1;
                    const t = Math.random();
                    
                    // Arm path - slightly bent
                    const armLength = 0.55;
                    const startY = 1.25;
                    const startX = side * 0.2;
                    
                    y = startY - t * armLength * 0.7;
                    x = startX + side * t * 0.25;
                    z = t * 0.1 - 0.05;
                    
                    // Arm thickness
                    const thickness = 0.045 - t * 0.015;
                    const aAngle = Math.random() * Math.PI * 2;
                    x += Math.cos(aAngle) * thickness;
                    z += Math.sin(aAngle) * thickness;
                    
                    color = skinCool.clone().lerp(skinBase, Math.random() * 0.5);
                    size = 0.012 + Math.random() * 0.006;
                } else if (section < 0.62) {
                    // Hands
                    const side = Math.random() > 0.5 ? 1 : -1;
                    x = side * 0.45 + (Math.random() - 0.5) * 0.08;
                    y = 0.75 + (Math.random() - 0.5) * 0.08;
                    z = 0.05 + (Math.random() - 0.5) * 0.06;
                    color = skinWarm.clone();
                    size = 0.01 + Math.random() * 0.005;
                } else if (section < 0.85) {
                    // Legs
                    const side = Math.random() > 0.5 ? 1 : -1;
                    const t = Math.random();
                    
                    y = 0.7 - t * 0.7;
                    x = side * 0.1;
                    z = 0;
                    
                    // Leg thickness - thicker at top
                    const thickness = 0.08 - t * 0.03;
                    const lAngle = Math.random() * Math.PI * 2;
                    x += Math.cos(lAngle) * thickness;
                    z += Math.sin(lAngle) * thickness * 0.8;
                    
                    color = skinBase.clone().lerp(skinCool, t * 0.3);
                    size = 0.013 + Math.random() * 0.007;
                } else {
                    // Feet
                    const side = Math.random() > 0.5 ? 1 : -1;
                    x = side * 0.1 + (Math.random() - 0.5) * 0.06;
                    y = Math.random() * 0.05;
                    z = (Math.random() - 0.3) * 0.12;
                    color = skinCool.clone();
                    size = 0.011;
                }

                // Add subtle noise
                x += (Math.random() - 0.5) * 0.01;
                y += (Math.random() - 0.5) * 0.01;
                z += (Math.random() - 0.5) * 0.01;

                positions[i3] = x;
                positions[i3 + 1] = y;
                positions[i3 + 2] = z;

                colors[i3] = color.r;
                colors[i3 + 1] = color.g;
                colors[i3 + 2] = color.b;

                sizes[i] = size;
                opacities[i] = opacity;
            }

            const geometry = new THREE.BufferGeometry();
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            geometry.setAttribute('customColor', new THREE.BufferAttribute(colors, 3));
            geometry.setAttribute('size', new THREE.BufferAttribute(sizes, 1));
            geometry.setAttribute('opacity', new THREE.BufferAttribute(opacities, 1));

            const material = new THREE.ShaderMaterial({
                vertexShader: splatVertexShader,
                fragmentShader: splatFragmentShader,
                transparent: true,
                depthWrite: false,
                blending: THREE.NormalBlending
            });

            return new THREE.Points(geometry, material);
        }

        // Add environment - subtle floor reflection
        function createEnvironment() {
            const floorGeo = new THREE.CircleGeometry(5, 64);
            const floorMat = new THREE.MeshBasicMaterial({
                color: 0x111115,
                transparent: true,
                opacity: 0.5
            });
            const floor = new THREE.Mesh(floorGeo, floorMat);
            floor.rotation.x = -Math.PI / 2;
            floor.position.y = -0.01;
            return floor;
        }

        // Simulate loading
        let progress = 0;
        const loadingMessages = [
            'Initializing immersive experience...',
            'Loading Gaussian splats...',
            'Processing 150,000 splat points...',
            'Building spatial hierarchy...',
            'Optimizing render pipeline...',
            'Preparing 3D environment...',
            'Almost ready...'
        ];

        function simulateLoading() {
            progress += Math.random() * 12 + 4;
            if (progress > 100) progress = 100;
            
            loaderFill.style.width = progress + '%';
            const msgIndex = Math.min(Math.floor(progress / 15), loadingMessages.length - 1);
            loaderStatus.textContent = loadingMessages[msgIndex];

            if (progress < 100) {
                setTimeout(simulateLoading, 150 + Math.random() * 200);
            } else {
                setTimeout(() => {
                    loader.classList.add('hidden');
                    document.getElementById('splatCount').textContent = '150,000';
                    
                    setTimeout(() => {
                        instructions.classList.add('hidden');
                    }, 5000);
                }, 400);
            }
        }

        // Add objects to scene
        const figure = createGaussianFigure();
        scene.add(figure);
        scene.add(createEnvironment());

        // Start loading simulation
        setTimeout(simulateLoading, 300);

        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        // Window resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Control buttons
        document.getElementById('resetBtn').addEventListener('click', () => {
            camera.position.set(0, 1.2, 2.5);
            controls.target.set(0, 0.9, 0);
            controls.update();
        });

        document.getElementById('autoRotateBtn').addEventListener('click', (e) => {
            controls.autoRotate = !controls.autoRotate;
            e.currentTarget.classList.toggle('active', controls.autoRotate);
        });

        document.getElementById('zoomInBtn').addEventListener('click', () => {
            camera.position.lerp(controls.target, 0.2);
        });

        document.getElementById('zoomOutBtn').addEventListener('click', () => {
            const dir = camera.position.clone().sub(controls.target).normalize();
            camera.position.add(dir.multiplyScalar(0.5));
        });

        document.getElementById('infoBtn').addEventListener('click', (e) => {
            infoPanel.classList.toggle('visible');
            e.currentTarget.classList.toggle('active');
        });

        document.getElementById('fullscreenBtn').addEventListener('click', () => {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
                document.querySelector('.expand-icon').style.display = 'none';
                document.querySelector('.compress-icon').style.display = 'block';
            } else {
                document.exitFullscreen();
                document.querySelector('.expand-icon').style.display = 'block';
                document.querySelector('.compress-icon').style.display = 'none';
            }
        });

        // VR button
        document.getElementById('vrBtn').addEventListener('click', () => {
            document.getElementById('vrPrompt').classList.add('visible');
        });

        document.getElementById('enterVrBtn').addEventListener('click', () => {
            if (navigator.xr) {
                navigator.xr.requestSession('immersive-vr').then((session) => {
                    document.getElementById('vrPrompt').classList.remove('visible');
                }).catch(() => {
                    alert('VR not available on this device');
                    document.getElementById('vrPrompt').classList.remove('visible');
                });
            } else {
                alert('WebXR not supported in this browser');
                document.getElementById('vrPrompt').classList.remove('visible');
            }
        });

        document.getElementById('vrPrompt').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                e.currentTarget.classList.remove('visible');
            }
        });

        // Hide/show UI on inactivity
        let uiTimeout;
        function showUI() {
            viewerControls.classList.remove('hidden');
            viewerTopbar.classList.remove('hidden');
            clearTimeout(uiTimeout);
            uiTimeout = setTimeout(hideUI, 3000);
        }

        function hideUI() {
            if (!infoPanel.classList.contains('visible')) {
                viewerControls.classList.add('hidden');
                viewerTopbar.classList.add('hidden');
            }
        }

        document.addEventListener('mousemove', showUI);
        document.addEventListener('click', showUI);
        showUI();
    </script>
</body>
</html>
